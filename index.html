<!DOCTYPE html>
<html>
<head>
	<title>Hello World!</title>
	<style>
		body {
			background: linear-gradient(to right, #9d0dd1, #490661);
		}
		h1 {
			text-align: center;
			color: white;
			margin-top: 20vh;
			font-size: 5em;
			font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif, sans-serif;
		}
		h2 {
		    text-align: center;
		    color: white;
		    margin-top 15vh;
		    font-size: 1em;
		    font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif, sans-serif;
		}
	</style>
	<script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
	<script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
	<script src="https://bundle.run/browserify-cipher@1.0.1"></script>
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
	<script>
		var { getSharedSecret, schnorr, utils } = nobleSecp256k1
		var crypto 	= window.crypto
		var getRand = size => crypto.getRandomValues(newUint8Array(size))
		var sha256 	= bitcoinjs.crypto.sha256
		var keypair = bitcoinjs.ECPair.makeRandom()
		var privKey = keypair.privateKey.toString( "hex" )
		var pubKey 	= keypair.publicKey.toString( "hex" )
		pubKey		= pubKey.substring( 2 )
		console.log( pubKey );
		// Below, connects to a relay
		var relay = "wss://relayable.org";
		var socket = new WebSocket( relay );
		// Below, log any messages the relay sends us
		socket.addEventListener('message', async function( message ) {
			var [ type, subId, event ] = JSON.parse( message.data );
			var { kind, content } = event || {}
			if (!event) return
			console.log('message', event)
			if (kind === 4) {
				content = await decrypt(privKey, pubKey, content)
			}
			console.log('content', content)
		}) // Below, Subscribe to yourself
		var subId = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" )
		var filter = { "authors": [ pubKey ] }
		
		socket.addEventListener('open', async function( e ) {
			console.log( "connected to " + relay )
		
			var subscription = [ "REQ", subId, filter ]
			console.log('Subscription:', subscription)
			
			socket.send(JSON.stringify( subscription ));
		// ## Sign and send a public note
		// put this stuff inside the "open" event listener from earlier
        		var event = {
        		    "content"	    : "this workshop is awesome!",
        		    "created_at"	: Math.floor( Date.now() / 1000 ),
        		    "kind"		    : 1,
        		    "tags"	    	: [],
        		    "pubkey"    	: pubKey,
        	}
        	var signedEvent = await getSignedEvent(event, privKey)
        	console.log('signedEvent:', signedEvent)
        	socket.send(JSON.stringify([ "EVENT", signedEvent ]))
        }) //close this bracket, but we'll put more stuff in here later
		// ## Prepare a public note for signing
		// Referenced here: https://github.com/nostr-protocol/nips/blob/master/01.md
			async function getSignedEvent(event, privateKey) {
				var eventData = JSON.stringify([
					0,						// Reserved for future use
					event['pubkey'],		// The sender's public key
					event['created at'],	// Unix timestamp
					event['kind'],			// Message "kind" or type
					event['tags'],			// tags identify replies/recipients
					event['content']		// Your note contents
				])
	        event.id = sha256( eventData ).toString( 'hex' )
	        event.sig = await schnorr.sign( event.id, privateKey )
	        return event
		}
	</script>
	<h1>Hello World ;)</h1>
	<h2>This is Danny's Test Implementation of the Nostr Workshop with Super Testnet conducted by <a href="https://www.youtube.com/watch?v=HbicnlCXg_Y">PlebLabs</a></h2>
</body>
</html>